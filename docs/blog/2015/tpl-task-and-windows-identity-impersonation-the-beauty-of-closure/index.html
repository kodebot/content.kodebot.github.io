
<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.54.0" />
  <meta name="description" content="">


  <link rel="icon" href="/images/favicon.ico" type="image/png">
  <title>TPL Task and Windows Identity Impersonation - The beauty of Closure - Kodebot</title>

  
  <link href="/css/nucleus.css?1566054737" rel="stylesheet">
  <link href="/css/fontawesome-all.min.css?1566054737"
    rel="stylesheet">
  <link href="/css/hybrid.css?1566054737" rel="stylesheet">
  <link href="/css/featherlight.min.css?1566054737" rel="stylesheet">
  <link href="/css/perfect-scrollbar.min.css?1566054737"
    rel="stylesheet">
  <link href="/css/auto-complete.css?1566054737" rel="stylesheet">
  <link href="/css/atom-one-dark-reasonable.css?1566054737"
    rel="stylesheet">
  <link href="/css/theme.css?1566054737" rel="stylesheet">
  <link href="/css/hugo-theme.css?1566054737" rel="stylesheet">
  
  <link href="/css/theme-mine.css?1566054737"
    rel="stylesheet">
  

  <script src="/js/jquery-3.3.1.min.js?1566054737"></script>

  <style type="text/css">
    :root #header+#content>#left>#rlblock_left {
      display: none !important;
    }

      {
        {
        if .Site.Params.disableInlineCopyToClipBoard
      }
    }

    :not(pre)>code+span.copy-to-clipboard {
      display: none;
    }

      {
        {
        end
      }
    }
  </style>
  
</head>

<body class="" data-url="/blog/2015/tpl-task-and-windows-identity-impersonation-the-beauty-of-closure/">
  <nav class="main-menu">
    <div class="logo">
        <a href="https://kodebot.com/">
            <img src="/images/logo.png" style="background: white; padding-right: 2px;">
        </a>
    </div>
    <ul>
        
        
        
                
        <li >
            <a href="/blog/" 
            class="active"
            >
                Blog
            </a>
        </li>

        
                
        <li >
            <a href="/tutorials/" >
                Tutorials
            </a>
        </li>

        
                
        <li >
            <a href="/about/" >
                About
            </a>
        </li>

        
        
    </ul>
</nav>
  <section id="body" class="no-sidebar">
    <div id="overlay"></div>
    <div class="padding highlightable">
      
      <div>
        
        
        <div id="top-bar">
          


          <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
            <span class="links">
              
          
          
          
          
          
          
          
          
          
          
          <a href='/'>Kodebot</a> > <a href='/blog/'>Blog</a> > TPL Task and Windows Identity Impersonation - The beauty of Closure
          
          
          
          
          
          
            </span>
          </div>
        </div>
        
      </div>
      
      <div id="head-tags">
        
<div class="tags">

  <a class="tag-link" href="/tags/c">C#</a>

</div>

      </div>
      
        <div id="body-inner">
          
          <h1>
            
            TPL Task and Windows Identity Impersonation - The beauty of Closure
          </h1>
          

          

<p>I have created a web application with Windows Authentication and impersonation is enabled as I need the application connect to SQL Server database using Windows Authentication.</p>
<p>I wanted&nbsp;to run a TPL task in the impersonated context, so, I added the following code naively in a&nbsp;action method of one of my controllers</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#75715e">// naive task code
</span><span style="color:#75715e"></span>
Task.Run(() =&gt;
{
      <span style="color:#75715e">// Task code here
</span><span style="color:#75715e"></span>});</code></pre></div>
<p>Though, <a href="https://social.msdn.microsoft.com/Forums/vstudio/en-US/a1da0143-919c-433d-9d50-83795879082d/tasks-and-impersonation?forum=parallelextensions" target="_blank">this answer</a>&nbsp;suggests that tasks will run under the same context under which it was created, it wasn't working that way in my case.</p>
<p>The task is created under impersonated context but the task was invoked under the identity configured in application pool which is network service in this case.&nbsp;</p>

<p>To make this work, I need to invoke the method in the task under impersonated context. The easiest way is to capture the <code>WindowsIdentity</code> and make it available to the task function so it can execute any code under the impersonated&nbsp;context.</p>

<p>The Closure feature helped me to achieve this elegantly. &nbsp;This means, lambda expressions or lambda functions can access any variables declared in the block where the lambda expressions or lambda functions&nbsp;are defined. So, I created a local variable in my action method and used in the task function to run code under the impersonated context. Here is the sample code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// Task using closure
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">currentWindowsIdentity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">WindowsIdentity</span>.<span style="color:#a6e22e">GetCurrent</span>();
<span style="color:#a6e22e">Task</span>.<span style="color:#a6e22e">Run</span>(() =&gt;
{

    <span style="color:#a6e22e">using</span> (<span style="color:#a6e22e">currentWindowsIdentity</span>.<span style="color:#a6e22e">Impersonate</span>())
    {
        <span style="color:#75715e">// Task code here
</span><span style="color:#75715e"></span>    }

});
</code></pre></div>

<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/blog/2015/mvc-6-camel-case-json/" title="MVC 6 Camel Case JSON"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/blog/2015/selenium-and-page-objects/" title="Selenium and Page Objects" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1566054737"></script>
    <script src="/js/perfect-scrollbar.min.js?1566054737"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1566054737"></script>
    <script src="/js/jquery.sticky.js?1566054737"></script>
    <script src="/js/featherlight.min.js?1566054737"></script>
    <script src="/js/html5shiv-printshiv.min.js?1566054737"></script>
    <script src="/js/highlight.pack.js?1566054737"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1566054737"></script>
    <script src="/js/learn.js?1566054737"></script>
    <script src="/js/hugo-learn.js?1566054737"></script>

    <link href="/mermaid/mermaid.css?1566054737" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1566054737"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    


    <div class="custom-footer">
        <div class="copy">
            &copy; 2014 - 2019 Kodebot Limited. All Rights Reserved.<br>
        </div>
        <div class="license">
            All content on this website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">
                (CC
                BY-SA 3.0)
                Creative Commons Attribution-ShareAlike 3.0 Unported License</a>. All source code published here is
            licensed
            under the
            <a href="http://opensource.org/licenses/MIT"> MIT License</a> unless explicitly stated otherwise. The
            content is
            provided for
            educational and informational purposes only without any warranties, guarantees or conditions, of any kind,
            and
            may not be accurate,
            up to date or complete. Any use or reliance on any content or materials published, mentioned or linked here
            is
            at your own risk and
            the Kodebot Limited and author/authors accept no liability or responsibility for.
        </div>
    </div>

  </body>
</html>
